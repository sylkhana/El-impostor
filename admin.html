<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Admin</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">

  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Roboto', sans-serif;
      background: linear-gradient(to right, #6a11cb, #2575fc);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      color: #333;
    }
    .admin-container {
      background: #fff;
      padding: 40px 30px;
      border-radius: 14px;
      box-shadow: 0 12px 30px rgba(0,0,0,0.25);
      width: 100%;
      max-width: 700px;
      text-align: center;
    }
    h1 { color: #2575fc; margin-bottom: 20px; }
    label { display: block; margin-top: 15px; font-weight: 700; }
    input, select, textarea, button {
      width: 100%;
      padding: 10px;
      margin-top: 5px;
      border-radius: 8px;
      border: 1px solid #ccc;
      font-size: 16px;
    }
    button {
      background: #2575fc;
      color: white;
      font-weight: 700;
      margin-top: 20px;
      cursor: pointer;
      transition: background 0.3s;
    }
    button:hover { background: #6a11cb; }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: center;
    }
    th { background: #f0f0f0; }
  </style>
</head>

<body>
  <div class="admin-container">
    <h1>Panel Admin</h1>

    <label for="ronda">Número de ronda</label>
    <input type="number" id="ronda" value="1" min="1">

    <table id="tabla_cofres">
      <thead>
        <tr>
          <th>Jugador</th>
          <th>Rol</th>
          <th>Pista</th>
        </tr>
      </thead>
      <tbody>
        <!-- Filas dinámicas desde JS -->
      </tbody>
    </table>

    <label for="objetivo_impostor">Objetivo impostor</label>
    <textarea id="objetivo_impostor" rows="2"></textarea>

    <label for="objetivo_contendiente">Objetivo contendientes</label>
    <textarea id="objetivo_contendiente" rows="2"></textarea>

	<label for="clave">Clave</label>
    <textarea id="clave" rows="1"></textarea>

    <button id="guardar">Guardar</button>
  </div>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

    const supabase = createClient(
      'https://fcyswptxwdzhvwekkdhl.supabase.co',
      'sb_publishable_MxkPdd565iYMTMj2QGpFaw_ZZqbmLmv'
    );

    const tablaBody = document.querySelector('#tabla_cofres tbody');

    //Cargar jugadores de la tabla cofres
    async function cargarCofres() {
      const { data, error } = await supabase.from('cofres').select('*');
      if (error) { alert('Error al cargar cofres'); console.error(error); return; }

      tablaBody.innerHTML = '';
      data.forEach(j => {
        const tr = document.createElement('tr');

        // Jugador (texto fijo)
        const tdJugador = document.createElement('td');
        tdJugador.textContent = j.jugador;
        tr.appendChild(tdJugador);

        // Rol (select)
        const tdRol = document.createElement('td');
        const select = document.createElement('select');
        ['IMPOSTOR','CONTENDIENTE','ELIMINADO'].forEach(r => {
          const option = document.createElement('option');
          option.value = r;
          option.textContent = r;
          if(r === j.rol) option.selected = true;
          select.appendChild(option);
        });
        tdRol.appendChild(select);
        tr.appendChild(tdRol);

        // Pista (input)
        const tdPista = document.createElement('td');
        const inputPista = document.createElement('input');
        inputPista.type = 'text';
        inputPista.value = j.pista || '';
        tdPista.appendChild(inputPista);
        tr.appendChild(tdPista);

        tablaBody.appendChild(tr);
      });
    }

    cargarCofres();

    // 2️. Guardar cambios
    document.getElementById('guardar').addEventListener('click', async () => {
      const ronda = parseInt(document.getElementById('ronda').value);
      const objetivoImpostor = document.getElementById('objetivo_impostor').value;
      const objetivoContendiente = document.getElementById('objetivo_contendiente').value;
	  const clave = document.getElementById('clave').value;

      // 2b. Actualizar datos de cada jugador
      const filas = Array.from(tablaBody.querySelectorAll('tr'));
      for (const fila of filas) {
		console.log("fila");
        const jugador = fila.cells[0].textContent;
        const rol = fila.cells[1].querySelector('select').value;
        var pista = fila.cells[2].querySelector('input').value;
		var objetivo = ""
		
		if (rol === "IMPOSTOR") {
			objetivo = objetivoImpostor
		}
		else if (rol == "ELIMINADO") {
			objetivo = ""
			pista = ""
		}
		else {
			objetivo = objetivoContendiente
		}
		
		const { error } = await supabase.rpc('actualizar_cofre', {p_jugador: jugador,
																  p_rol: rol,
																  p_pista: pista,
																  p_objetivo: objetivo,
																  p_ronda: ronda,
																  p_clave: clave
																});
        if (error) console.error('Error al actualizar jugador', jugador, error);
      }



      alert('Datos guardados correctamente');
      cargarCofres();
    });
  </script>
</body>
</html>
